<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Итоговый проект курса — Безопасный бизнес</title>
<style>
  :root{
    --bg:#ffffff;
    --fg:#0f172a; /* slate-900 */
    --muted:#475569; /* slate-600 */
    --accent:#2563eb; /* blue-600 */
    --accent-2:#10b981; /* emerald-500 */
    --warn:#ef4444; /* red-500 */
    --card:#f8fafc; /* slate-50 */
    --border:#e2e8f0; /* slate-200 */
    --chip:#e0e7ff; /* indigo-100 */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--fg);background:var(--bg)}
  a{color:var(--accent);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
  .title{display:flex;gap:16px;align-items:center}
  .badge{font-size:12px;background:var(--chip);color:#3730a3;border:1px solid #c7d2fe;padding:4px 8px;border-radius:999px}
  .grid{display:grid;gap:18px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 1px 0 rgba(15,23,42,.04)}
  .h1{font-size:28px;margin:8px 0 6px}
  .h2{font-size:20px;margin:0 0 10px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px;font-size:12px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .item{background:white;border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-width:160px}
  .progress{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 2px 0 rgba(37,99,235,.2)}
  .btn.secondary{background:#111827;color:#F9FAFB}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .ok{color:var(--accent-2);font-weight:600}
  .bad{color:var(--warn);font-weight:600}
  .status{display:flex;gap:8px;align-items:center}
  .status .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;border:1px solid var(--border)}
  .status.pass .dot{background:var(--accent-2)}
  .status.fail .dot{background:var(--warn)}
  .hint{font-size:13px;color:var(--muted)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#111827;color:#f9fafb;border-radius:6px;padding:1px 6px;font-size:12px}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;background:#fff}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#f1f5f9;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
  .chip.ok{background:#ecfdf5;border:1px solid #86efac}
  textarea,input[type="text"],input[type="number"],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .task{counter-increment:task}
  .task .h2::before{content:"Задание " counter(task) ". ";color:#1f2937}
  .tag{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .score{font-weight:700}
  .footer-note{font-size:12px;color:#64748b}
  .pass-banner{display:none;margin:8px 0 0;padding:10px 12px;border:1px dashed var(--accent-2);border-radius:12px;background:#ecfdf5}
  .pass-banner strong{color:#065f46}
  .confetti{position:fixed;inset:0;pointer-events:none;z-index:999}
  .tests{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
  pre{white-space:pre-wrap;background:#0b1020;color:#e5e7eb;padding:12px;border-radius:10px;max-height:260px;overflow:auto}
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <div>
          <div class="badge">Итоговый проект (продвинутый уровень)</div>
          <h1 class="h1">Безопасный бизнес: как работать с банком без блокировок</h1>
          <div class="muted">Единый кейс • HTML+CSS+JS • Автопроверка по ключевым словам • Достаточно 80% для статуса <span class="kbd">Пройден</span></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2 class="h2">Кейс: «Маркет‑Решения» и приостановление операций по счёту</h2>
      <p><strong>Ситуация.</strong> У ООО «Маркет‑Решения» банк приостановил операции по счёту и направил запрос пояснений по ряду платежей. Банк указал на возможные признаки сомнительных операций: транзиты, низкая доля налогов к обороту, несоответствие назначения платежей ОКВЭД, а также вопросы к одному из контрагентов. Ваша задача — подготовить полный пакет аналитики и коммуникации, чтобы снять блокировку и укрепить систему комплаенса.</p>
      <div class="kpi">
        <div class="item"><div class="muted">Минимальный порог для зачёта</div><div class="score">80%</div></div>
        <div class="item"><div class="muted">Ваш результат</div><div class="score" id="totalScore">0%</div><div class="progress" aria-label="Прогресс"><span id="progressBar"></span></div><div id="passBanner" class="pass-banner">✅ <strong>Пройден.</strong> Вы набрали ≥ 80%.</div></div>
        <div class="item"><div class="muted">Статус</div><div id="statusBox" class="status"><span class="dot"></span><span class="muted">Ожидает выполнения</span></div></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn" id="checkAll">Проверить всё</button>
        <button class="btn ghost" id="save">Сохранить прогресс</button>
        <button class="btn ghost" id="reset">Сбросить всё</button>
      </div>
      <p class="hint">Примечание: промежуточный прогресс сохраняется в <span class="kbd">localStorage</span> (если доступно).</p>
    </section>

    <!-- Задание 1 -->
    <section class="card task" id="t1">
      <h3 class="h2">Выявление красных флагов в операциях</h3>
      <p>Проанализируйте фрагмент реестра операций за 3 недели. Отметьте операции, которые потенциально являются риск‑факторами (транзит, обналичивание, дробление, несоответствие профилю, аномалии).</p>
      <div class="grid cols-2">
        <div>
          <table class="tbl" aria-describedby="t1">
            <thead>
              <tr><th>Дата</th><th>Сумма, ₽</th><th>Назначение</th><th>Примечание</th></tr>
            </thead>
            <tbody>
              <tr><td>03.06</td><td>1 980 000</td><td>Поступление от ООО «Delta»</td><td>Счёт‑фактура №145</td></tr>
              <tr><td>03.06</td><td>1 970 000</td><td>Перевод ООО «Gamma‑Снаб»</td><td>Оплата услуг маркетинга</td></tr>
              <tr><td>05.06</td><td>680 000</td><td>Снятие наличных</td><td>Выдача под отчёт</td></tr>
              <tr><td>06.06</td><td>15 000</td><td>Платёж физлицу</td><td>Перевод Иванову И.И.</td></tr>
              <tr><td>10.06</td><td>2 400 000</td><td>Поступление от ИП Петров</td><td>Аванс</td></tr>
              <tr><td>10.06</td><td>2 380 000</td><td>Перевод ИП Петров</td><td>Возврат аванса</td></tr>
              <tr><td>12.06</td><td>97 000</td><td>Налоги (КБК)</td><td>Срок уплаты</td></tr>
              <tr><td>14.06</td><td>1 250 000</td><td>Оплата аренды</td><td>Договор А‑2024</td></tr>
              <tr><td>17.06</td><td>37 000</td><td>НДФЛ</td><td>З/п май</td></tr>
              <tr><td>17.06</td><td>520 000</td><td>Переводы сотрудникам</td><td>З/п май</td></tr>
              <tr><td>19.06</td><td>1 150 000</td><td>Услуги IT</td><td>ООО «Cloud‑Team», акт №512</td></tr>
              <tr><td>19.06</td><td>1 140 000</td><td>Поступление от ООО «Cloud‑Team»</td><td>Оплата за рекламу</td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="chips">
            <label class="chip"><input type="checkbox" data-t1="1"/> 03.06 → 03.06 (почти равные суммы) — возможный транзит</label>
            <label class="chip"><input type="checkbox" data-t1="2"/> 05.06 снятие 680 000 ₽ — риск обналичивания</label>
            <label class="chip"><input type="checkbox" data-t1="3"/> 06.06 перевод физлицу — вне профиля</label>
            <label class="chip"><input type="checkbox" data-t1="4"/> 10.06 аванс → возврат — аномалия/цикличность</label>
            <label class="chip"><input type="checkbox" data-t1="5"/> 17.06 НДФЛ + з/п — свидетельство дисциплины (НЕ флаг)</label>
            <label class="chip"><input type="checkbox" data-t1="6"/> 19.06 взаимные платежи с «Cloud‑Team» — потенциальный транзит</label>
            <label class="chip"><input type="checkbox" data-t1="7"/> 12.06 налоги к обороту низкие — риск</label>
          </div>
          <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT1()">Проверить задание 1</button> <span id="r1"></span></div>
          <div class="hint">Подсказка: не все пункты — флаги. Учтите контекст.</div>
        </div>
      </div>
    </section>

    <!-- Задание 2 -->
    <section class="card task" id="t2">
      <h3 class="h2">Расчёт налоговой нагрузки к обороту</h3>
      <p>Вычислите две метрики за квартал: (A) только налоги к обороту; (B) налоги + НДФЛ + страховые взносы к обороту. Введите результаты в процентах с точностью до десятых.</p>
      <div class="grid cols-2">
        <div>
          <table class="tbl">
            <thead><tr><th>Месяц</th><th>Оборот по счёту, ₽</th><th>Налоги (КБК), ₽</th><th>НДФЛ, ₽</th><th>Взносы, ₽</th></tr></thead>
            <tbody>
              <tr><td>М1</td><td data-ob="8500000">8 500 000</td><td data-tax="20000">20 000</td><td data-ndfl="0">0</td><td data-vzn="0">0</td></tr>
              <tr><td>М2</td><td data-ob="9700000">9 700 000</td><td data-tax="150000">150 000</td><td data-ndfl="230000">230 000</td><td data-vzn="350000">350 000</td></tr>
              <tr><td>М3</td><td data-ob="6500000">6 500 000</td><td data-tax="40000">40 000</td><td data-ndfl="190000">190 000</td><td data-vzn="280000">280 000</td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <label>Метрика A — только налоги, % <input type="number" step="0.1" id="t2a" placeholder="например, 0.8"/></label>
          <label style="margin-top:8px;display:block">Метрика B — налоги+НДФЛ+взносы, % <input type="number" step="0.1" id="t2b" placeholder="например, 5.1"/></label>
          <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT2()">Проверить задание 2</button> <span id="r2"></span></div>
          <p class="hint">Окно допуска ±0,1 п.п. Итоговую интерпретацию дайте в Задании 5 (пояснение банку).</p>
        </div>
      </div>
    </section>

    <!-- Задание 3 -->
    <section class="card task" id="t3">
      <h3 class="h2">Проверка контрагента «ООО Альфа‑Маркет»</h3>
      <p><strong>Данные из открытых источников (условные):</strong> юрадрес — Москва, ул. Прудная, 7 (в реестре массовый); уставный капитал — 10 000 ₽; директор — значится руководителем в 24 компаниях; штат — 1 сотрудник; сайт/офис отсутствуют; отчётность — нулевая за прошлый год; участие в ЭДО — нет; налоговая задолженность — 0 ₽.</p>
      <div class="grid cols-2">
        <div>
          <p><strong>Отметьте признаки риска:</strong></p>
          <div class="chips">
            <label class="chip"><input type="checkbox" data-t3="1"/> Массовый адрес</label>
            <label class="chip"><input type="checkbox" data-t3="2"/> Минимальный уставный капитал</label>
            <label class="chip"><input type="checkbox" data-t3="3"/> Директор в десятках фирм</label>
            <label class="chip"><input type="checkbox" data-t3="4"/> Отсутствие сайта/офиса</label>
            <label class="chip"><input type="checkbox" data-t3="5"/> Нулевая отчётность</label>
            <label class="chip"><input type="checkbox" data-t3="6"/> Наличие налоговой задолженности</label>
            <label class="chip"><input type="checkbox" data-t3="7"/> Нет участия в ЭДО</label>
          </div>
        </div>
        <div>
          <label>Кратко опишите 3 ключевых риска (через запятую)
            <input type="text" id="t3text" placeholder="например: массовый адрес, нулевая отчётность, директор в 24 компаниях"/>
          </label>
          <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT3()">Проверить задание 3</button> <span id="r3"></span></div>
          <p class="hint">Проверка текста — по ключевым словам/основам слов (массов, нулев, директор, офиса, ЭДО и т.п.).</p>
        </div>
      </div>
    </section>

    <!-- Задание 4 -->
    <section class="card task" id="t4">
      <h3 class="h2">Комплект документов для банка</h3>
      <p>Сформируйте пакет для подтверждения реальности сделки с «ООО Альфа‑Маркет» на услуги маркетинга.</p>
      <div class="chips">
        <label class="chip"><input type="checkbox" data-t4="d1"/> Договор и спецификация</label>
        <label class="chip"><input type="checkbox" data-t4="d2"/> Счёт/счёт‑фактура</label>
        <label class="chip"><input type="checkbox" data-t4="d3"/> Акт выполненных работ</label>
        <label class="chip"><input type="checkbox" data-t4="d4"/> Бриф/ТЗ/переписка</label>
        <label class="chip"><input type="checkbox" data-t4="d5"/> Пояснительная записка (экономический смысл)</label>
        <label class="chip"><input type="checkbox" data-t4="d6"/> Сканы без подписей и печатей</label>
        <label class="chip"><input type="checkbox" data-t4="d7"/> Выписки/платёжные поручения</label>
        <label class="chip"><input type="checkbox" data-t4="d8"/> Фото офиса контрагента</label>
      </div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT4()">Проверить задание 4</button> <span id="r4"></span></div>
      <p class="hint">Нужны деловые документы по сделке, а не случайные подтверждения.</p>
    </section>

    <!-- Задание 5 -->
    <section class="card task" id="t5">
      <h3 class="h2">Пояснение в банк (draft)</h3>
      <p>Напишите черновик пояснения в банк (5–10 предложений), обосновывающий экономический смысл операций и устранение рисков. Упомяните метрики из Задания 2.</p>
      <textarea id="t5text" rows="7" placeholder="Структура: цель письма → описание операций → экономический смысл → ссылка на договор/акт → ОКВЭД → назначение платежа → метрики налоговой нагрузки → меры усиления контроля → перечень приложений"></textarea>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT5()">Проверить задание 5</button> <span id="r5"></span></div>
      <p class="hint">Автопроверка ищет ключевые основы слов: договор, акт, экономическ, оквэд, назначени, контрагент, налог, НДФЛ/взнос, процен, прилож, реальн и др.</p>
    </section>

    <!-- Задание 6 -->
    <section class="card task" id="t6">
      <h3 class="h2">Черновик обращения в Банк России</h3>
      <p>Если блокировка не снята — составьте текст обращения в Банк России (<a href="https://cbr.ru/Reception/Message/Register?messageType=Complaint" target="_blank" rel="noopener">сервис приёма обращений</a>). Кратко, по сути (5–8 пунктов), перечислите приложенные доказательства.</p>
      <textarea id="t6text" rows="6" placeholder="Укажите: 115-ФЗ, просьбу провести проверку действий банка, описание ситуации, ссылки на документы, перечень приложений, контактные данные, ожидаемые сроки ответа"></textarea>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT6()">Проверить задание 6</button> <span id="r6"></span></div>
      <p class="hint">Ключевые основы: 115‑ФЗ, проверк, разблок, обращени/жалоб, приложен, срок, доказат.</p>
    </section>

    <!-- Задание 7 -->
    <section class="card task" id="t7">
      <h3 class="h2">Квартальный план самопроверки (комплаенс)</h3>
      <p>Выберите мероприятия, которые войдут в регламент ежеквартальной проверки.</p>
      <div class="chips">
        <label class="chip"><input type="checkbox" data-t7="1"/> Проверка доли налогов к обороту</label>
        <label class="chip"><input type="checkbox" data-t7="2"/> Пересмотр ОКВЭД и актуализация сведений</label>
        <label class="chip"><input type="checkbox" data-t7="3"/> Выбор поставщиков по самой низкой цене без проверки</label>
        <label class="chip"><input type="checkbox" data-t7="4"/> Репроцедура KYC контрагентов</label>
        <label class="chip"><input type="checkbox" data-t7="5"/> Тренировка ответов на запросы банка</label>
        <label class="chip"><input type="checkbox" data-t7="6"/> Увеличение доли наличных расчётов</label>
        <label class="chip"><input type="checkbox" data-t7="7"/> Аудит документов (договор‑акт‑счёт‑фактура)</label>
      </div>
      <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT7()">Проверить задание 7</button> <span id="r7"></span></div>
    </section>

    <!-- Задание 8 -->
    <section class="card task" id="t8">
      <h3 class="h2">Соответствие ОКВЭД: сопоставьте платежи</h3>
      <p>Для каждого платежа отметьте соответствие профилю деятельности (маркетинговые услуги и разработка ПО указаны в ОКВЭД).</p>
      <div class="grid cols-2">
        <div>
          <table class="tbl">
            <thead><tr><th>#</th><th>Платёж</th><th>Ваш выбор</th></tr></thead>
            <tbody>
              <tr><td>1</td><td>Оплата аренды офиса</td><td>
                <select data-t8="1"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
              <tr><td>2</td><td>Разработка лендинга</td><td>
                <select data-t8="2"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
              <tr><td>3</td><td>Покупка бытовой техники для дома директора</td><td>
                <select data-t8="3"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
              <tr><td>4</td><td>Реклама в соцсетях</td><td>
                <select data-t8="4"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
              <tr><td>5</td><td>Оплата услуг фитнес‑клуба для сотрудников</td><td>
                <select data-t8="5"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
              <tr><td>6</td><td>Приобретение серверов для облачного хостинга</td><td>
                <select data-t8="6"><option value="">—</option><option>Соответствует</option><option>Не соответствует</option></select>
              </td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="actions" style="margin-top:10px"><button class="btn" onclick="gradeT8()">Проверить задание 8</button> <span id="r8"></span></div>
          <p class="hint">Думайте как комплаенс: аренда и серверы — ок при наличии договоров; личные расходы — нет; соцпакет зависит от политики и договора.</p>
        </div>
      </div>
    </section>


    <!-- Автотесты (для разработчика и проверки на Stepik/GitHub Pages) -->
    <section class="card tests">
      <h3 class="h2">Автотесты</h3>
      <p class="hint">Эти тесты помогают быстро убедиться, что проверки работают и функции определены. Они <strong>не меняют</strong> ваши ответы.</p>
      <div class="actions"><button id="runTests" class="btn ghost">Прогнать автотесты</button></div>
      <pre id="testLog">Готов к запуску…</pre>
    </section>

    <section class="card">
      <h3 class="h2">Итоги</h3>
      <p>Нажмите «Проверить всё», чтобы рассчитать общий балл. При результате ≥ 80% статус изменится на <span class="ok">Пройден</span>. Вы можете сохранить прогресс и вернуться к доработке позже.</p>
      <div class="actions"><button class="btn secondary" id="checkAllBottom">Проверить всё</button></div>
      <p class="footer-note">© Проект «Безопасный бизнес». Для публикации в Stepik через GitHub Pages/iframe. Контакты: borodulin.expert</p>
    </section>

    <canvas id="confetti" class="confetti" width="0" height="0" aria-hidden="true"></canvas>
  </main>

<script>
(function(){
  // ====== Utility ======
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const toPct = v => Math.max(0, Math.min(100, Math.round(v)));
  const storeKey = 'final_project_safe_business_v1';

  function saveState(){
    const state = {
      t1: $$('[data-t1]').map(cb=>cb.checked),
      t2a: $('#t2a').value, t2b: $('#t2b').value,
      t3: $$('[data-t3]').map(cb=>cb.checked), t3text: $('#t3text').value,
      t4: $$('[data-t4]').map(cb=>cb.checked),
      t5: $('#t5text').value,
      t6: $('#t6text').value,
      t7: $$('[data-t7]').map(cb=>cb.checked),
      t8: $$('[data-t8]').map(s=>s.value)
    };
    try{localStorage.setItem(storeKey, JSON.stringify(state));}catch(e){}
  }
    try{localStorage.setItem(storeKey, JSON.stringify(state));}catch(e){}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(storeKey);
      if(!raw) return;
      const s = JSON.parse(raw);
      if(s.t1){$$('[data-t1]').forEach((cb,i)=>cb.checked=!!s.t1[i]);}
      if(s.t2a!=null) $('#t2a').value = s.t2a;
      if(s.t2b!=null) $('#t2b').value = s.t2b;
      if(s.t3){$$('[data-t3]').forEach((cb,i)=>cb.checked=!!s.t3[i]);}
      if(s.t3text!=null) $('#t3text').value = s.t3text;
      if(s.t4){$$('[data-t4]').forEach((cb,i)=>cb.checked=!!s.t4[i]);}
      if(s.t5!=null) $('#t5text').value = s.t5;
      if(s.t6!=null) $('#t6text').value = s.t6;
      if(s.t7){$$('[data-t7]').forEach((cb,i)=>cb.checked=!!s.t7[i]);}
      if(s.t8){$$('[data-t8]').forEach((sel,i)=> sel.value = s.t8[i]||'');}
    }catch(e){}
  }
      if(s.t2a!=null) $('#t2a').value = s.t2a;
      if(s.t2b!=null) $('#t2b').value = s.t2b;
      if(s.t3){$$('[data-t3]').forEach((cb,i)=>cb.checked=!!s.t3[i]);}
      if(s.t3text!=null) $('#t3text').value = s.t3text;
      if(s.t4){$$('[data-t4]').forEach((cb,i)=>cb.checked=!!s.t4[i]);}
      if(s.t5!=null) $('#t5text').value = s.t5;
      if(s.t6!=null) $('#t6text').value = s.t6;
      if(s.t7){$$('[data-t7]').forEach((cb,i)=>cb.checked=!!s.t7[i]);}
      if(s.t8){$$('[data-t8]').forEach((sel,i)=> sel.value = s.t8[i]||'');}
      if(s.t9!=null) $('#t9text').value = s.t9;
      if(s.t10!=null) $('#t10text').value = s.t10;
    }catch(e){}
  }

  // ====== Keyword scoring (Russian basics) ======
  function countKeywordHits(text, stems){
    const t = (text||'').toLowerCase().replace(/[ё]/g,'е');
    let hits = 0;
    const matched = new Set();
    for(const s of stems){
      const re = new RegExp(s, 'i');
      if(re.test(t)){ hits++; matched.add(s); }
    }
    return {hits, matched: Array.from(matched)};
  }

  // ====== Graders ======
  const results = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0};

  // Task 1
  window.gradeT1 = function(){
    // Correct: 1,2,4,6,7 are risk flags; 3 is context-dependent but считаем флаг; 5 is NOT a flag
    const correct = new Set([1,2,3,4,6,7]);
    const chosen = $$('[data-t1]').map((cb,i)=> cb.checked ? (i+1) : null).filter(Boolean);
    let tp=0, fp=0, fn=0;
    for(const idx of chosen){ if(correct.has(idx)) tp++; else fp++; }
    for(const idx of correct){ if(!chosen.includes(idx)) fn++; }
    const precision = tp / Math.max(1, (tp+fp));
    const recall = tp / Math.max(1, (tp+fn));
    const score = Math.round(10 * ((precision + recall) / 2)); // 0..10 points
    results[1] = score;
    $('#r1').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 2
  window.gradeT2 = function(){
    const rows = $$('#t2 tbody tr');
    let ob=0,tax=0,ndfl=0,vzn=0;
    rows.forEach(tr=>{
      ob += +tr.querySelector('[data-ob]').dataset.ob;
      tax += +tr.querySelector('[data-tax]').dataset.tax;
      ndfl += +tr.querySelector('[data-ndfl]').dataset.ndfl;
      vzn += +tr.querySelector('[data-vzn]').dataset.vzn;
    });
    const A = (tax/ob)*100; // only taxes
    const B = ((tax+ndfl+vzn)/ob)*100; // broad metric
    const a = parseFloat($('#t2a').value);
    const b = parseFloat($('#t2b').value);
    let score=0, msg=[];
    const within = (x,y,eps) => Math.abs(x-y) <= eps;
    if(Number.isFinite(a) && within(a,A,0.1)) { score+=5; msg.push('A ок'); } else { msg.push(`A мимо (ожидалось ~${A.toFixed(1)}%)`); }
    if(Number.isFinite(b) && within(b,B,0.1)) { score+=5; msg.push('B ок'); } else { msg.push(`B мимо (ожидалось ~${B.toFixed(1)}%)`); }
    results[2] = score;
    $('#r2').innerHTML = score>=8 ? `<span class="ok">${score}/10</span> • ${msg.join(' · ')}` : `<span class="bad">${score}/10</span> • ${msg.join(' · ')}`;
    saveState();
    updateTotal();
  }

  // Task 3
  window.gradeT3 = function(){
    const correct = new Set([1,2,3,4,5,7]); // 6 (налоговая задолженность) не отмечаем как риск по данным
    const chosen = $$('[data-t3]').map((cb,i)=> cb.checked ? (i+1) : null).filter(Boolean);
    let tp=0, fp=0, fn=0;
    for(const idx of chosen){ if(correct.has(idx)) tp++; else fp++; }
    for(const idx of correct){ if(!chosen.includes(idx)) fn++; }
    const precision = tp / Math.max(1, (tp+fp));
    const recall = tp / Math.max(1, (tp+fn));
    let score = Math.round(7 * ((precision + recall) / 2)); // 7 points for checkboxes

    // Text keywords (3 points)
    const stems = ['массов','нулев','директор','офис','сайт','эдо','уставн','1 сотруд','минималь'];
    const {hits} = countKeywordHits($('#t3text').value, stems);
    const textScore = Math.min(3, hits);
    score += textScore;

    results[3] = score;
    $('#r3').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 4
  window.gradeT4 = function(){
    const must = new Set(['d1','d2','d3','d4','d5','d7']);
    const bad = new Set(['d6','d8']);
    const chosen = $$('[data-t4]').map(cb=> cb.checked ? cb.getAttribute('data-t4') : null).filter(Boolean);
    let score = 10;
    must.forEach(k=>{ if(!chosen.includes(k)) score -= 1.5; });
    bad.forEach(k=>{ if(chosen.includes(k)) score -= 1.5; });
    score = Math.max(0, Math.round(score));
    results[4] = score;
    $('#r4').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 5
  window.gradeT5 = function(){
    const stems = ['договор','акт','экономическ','оквед','назначени','контрагент','налог','ндфл','взнос','процент','прилож','реальн','обосн','сделк'];
    const {hits} = countKeywordHits($('#t5text').value, stems);
    const score = Math.min(10, hits);
    results[5] = score;
    $('#r5').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 6
  window.gradeT6 = function(){
    const stems = ['115','115-фз','провер','разблок','жалоб','обращен','прилож','срок','доказ','закон','банк россии'];
    const {hits} = countKeywordHits($('#t6text').value, stems);
    const score = Math.min(10, hits);
    results[6] = score;
    $('#r6').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 7
  window.gradeT7 = function(){
    const must = new Set([1,2,4,5,7]);
    const bad = new Set([3,6]);
    const chosen = $$('[data-t7]').map((cb,i)=> cb.checked ? (i+1) : null).filter(Boolean);
    let score = 10;
    must.forEach(k=>{ if(!chosen.includes(k)) score -= 1.5; });
    bad.forEach(k=>{ if(chosen.includes(k)) score -= 1.5; });
    score = Math.max(0, Math.round(score));
    results[7] = score;
    $('#r7').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }

  // Task 8
  window.gradeT8 = function(){
    const gold = {1:'Соответствует',2:'Соответствует',3:'Не соответствует',4:'Соответствует',5:'Не соответствует',6:'Соответствует'};
    const sel = $$('[data-t8]');
    let correct=0;
    sel.forEach(s=>{ const i = s.getAttribute('data-t8'); if(s.value===gold[i]) correct++; });
    const score = Math.round((correct/sel.length)*10);
    results[8] = score;
    $('#r8').innerHTML = score>=8 ? `<span class="ok">${score}/10</span>` : `<span class="bad">${score}/10</span>`;
    saveState();
    updateTotal();
  }
  function updateTotal(){
    const sum = Object.values(results).reduce((a,b)=>a+b,0);
    const maxSum = Object.keys(results).length * 10;
    const pct = toPct((sum / maxSum) * 100);
    $('#totalScore').textContent = pct + '%';
    $('#progressBar').style.width = pct + '%';
    const pass = pct >= 80;
    const sb = $('#statusBox');
    sb.classList.toggle('pass', pass);
    sb.classList.toggle('fail', !pass && pct>0);
    sb.querySelector('span+span').textContent = pass ? 'Пройден' : (pct>0 ? 'Выполнено частично' : 'Ожидает выполнения');
    const pb = $('#passBanner');
    pb.style.display = pass ? 'block' : 'none';
    if(pass) fireConfetti();
  }

  // Confetti (tiny, vanilla)
  function fireConfetti(){
    const c = $('#confetti');
    const ctx = c.getContext('2d');
    const w = c.width = window.innerWidth; const h = c.height = window.innerHeight;
    const N = 150; const parts = [];
    for(let i=0;i<N;i++) parts.push({x:Math.random()*w,y:-Math.random()*h,vx:(Math.random()-0.5)*2,vy:Math.random()*2+1,size:Math.random()*4+2,life:Math.random()*120+60});
    let frame=0; const id = setInterval(()=>{
      ctx.clearRect(0,0,w,h);
      parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life--; ctx.fillStyle=`hsl(${(p.x+p.y)%360},80%,60%)`; ctx.fillRect(p.x,p.y,p.size,p.size);});
      if(++frame>160){ clearInterval(id); ctx.clearRect(0,0,w,h); }
    },16);
  }
  // Global actions
  function checkAll(){ gradeT1(); gradeT2(); gradeT3(); gradeT4(); gradeT5(); gradeT6(); gradeT7(); gradeT8(); }
  $('#checkAll').addEventListener('click', checkAll);
  $('#checkAllBottom').addEventListener('click', checkAll);
  $('#save').addEventListener('click', ()=>{ saveState(); alert('Прогресс сохранён (если разрешено localStorage).'); });
  $('#reset').addEventListener('click', ()=>{ if(confirm('Сбросить все ответы?')){ try{localStorage.removeItem(storeKey);}catch(e){}; location.reload(); }});

  // Init
  loadState();
  updateTotal();
})();
</script>
</body>
</html>
